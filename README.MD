# Shop Authentication Service For AapanaVypar

This service is created to enable authentication mechanism in AapanaVypar application.

## Note : For Me Add Feature To Count Total No Of SignIn Devices -> Count Total No Of Allocated Refresh Token To A Single User.

## Services

- **[Signup](#Signup) ( To Create Account ).**

- **[ContactConformation](#ContactConformation) ( To Conform Contact ).**

- **[ResendOTP](#ResendOTP) ( To Resend OTP ).**

- **[GetNewToken](#GetNewToken) ( To Get New Auth Token ).**

- **[SignIn](#SignIn) ( To Login Into Your Account ).**

- **[Logout](#Logout) ( To Logout From Account ).**

- **[ForgetPassword](#ForgetPassword) ( To Initiate Forget Password Flow ).**

- **[ConformForgetPasswordOTP](#ConformForgetPasswordOTP) ( To Validate Your Identity To Forget Password Service ).**

- **[SetNewPassword](#SetNewPassword) ( To Set New Password ).**

### Signup

Request

    message SignUpRequest {
        string username = 25;
        string password = 26;
        string phoneNo = 27;
        string email = 28;
        string apiKey = 106;

    }  
    
Response 
  
    message SignUpResponse {
        ResponseData responseData = 40;
        bool authorized = 50;
    }


### ContactConformation

Request

    message ContactConformationRequest {
        string token = 33;
        string otp = 34;
        string apiKey = 107;
    }


Response

    message ContactConformationResponse {
        string token = 35;
        string refreshToken = 36;
    }


### ResendOTP

Request

    message ResendOTPRequest {
        string token = 54;
        string apiKey = 108;
    }

Response

    message ResendOTPResponse {
        OTPResponse response = 55;
        google.protobuf.Duration timeToWaitForNextRequest = 56;
    }

### GetNewToken

Request

    message newTokenRequest {
        string refreshToken = 21;
        string apiKey = 109;
    }

Response

    message newTokenResponse {
        string token = 22;
    }

### SignIn

Request

    message SignInRequest {
        string phoneNo = 8;
        string password = 9;
        string apiKey = 105;
    }

Response

    message SignInResponse {
        ResponseData responseData = 10;
    }

### Logout

Request

    message LogoutRequest {
        string token = 36;
        string apiKey = 104;
    }

Response

    message LogoutResponse{
        bool status = 37;
    }

### ForgetPassword

Request

    message ForgetPasswordRequest {
        string phoNo = 55;
        string apiKey = 101;
    }

Response

    message ForgetPasswordResponse {
        ResponseData responseData = 10;
    }

### ConformForgetPasswordOTP

Request

    message ConformForgetPasswordOTPRequest {
        string otp = 59;
        string token = 60;
        string apiKey = 102;
    }

Response

    message ConformForgetPasswordOTPResponse {
        string newPassToken = 71;
    }

### SetNewPassword

Request

    message SetNewPasswordRequest {
        string newPassToken = 72;
        string newPassword = 73;
        string apiKey = 103;
    }

Response

    message SetNewPasswordResponse {
        bool status = 74;
    }


## Highlight's

  - A Token generated by a rpc (function) can only be utilized by the specified rpc's.
  - All the requests are first sanitized and then processed.
  - The token is encrypted and then only send to the client.
  - OTP is conformed on server side.
  - Security in structure.
  - The allocated token are valid upto certain time period depending upon authorized and unauthorized user. 
     **Refresh token for authorized user   = 2 weeks**   
     **Refresh token for unauthorized user = 30 min**
  - The user who tried to signUp and utilized his all OTP tries then he can try again after 3 hours with that contact number.
  - Only for half hour to OTP resides in cash after it get automatically deleted.
  - All the end points / rpc's are protected with API Key to prevent various attacks.
  - Limit on generation of auth token by the use of refresh token.   
    **Maximum token generation for authorized user   = 12**    
    **Maximum token generation for unauthorized user = 7**
  - The token generated for password reset is different from a token generated for other rpc's this increases security.    
    **password token is valid only for 5 min form generation.**
  - The user can be able to get otp 6 times in all cases for a particular account   
     1st : First time otp get send automatically.   
     2nd : when user click on resend otp.  
     3rd : After 5 min wait when user click on resend otp.   
     4th : After 10 min wait when user click on resend otp.  
     5th : After 15 min wait when user click on resend otp.  
     6th : Exhausted Limit. 


## Error Codes

### 1. SignUp :
   - **Unauthenticated** : No API Key Is Specified  
   - **InvalidArgument** : Unable To Validate Provided Inputs   
   - **AlreadyExists**   : User Already Exist   
   - **AlreadyExists**   : Process In Progress  
   - **Internal**        : Unable To Generate UUID  
   - **Internal**        : Unable To Generate Hash  
   - **Internal**        : Unable To Add User To Cash   
   - **Internal**        : Unable To Add User To Cash Of Waiting users   
   - **Internal**        : Unable To Generate Refresh Token 
   - **Internal**        : Unable To Send OTP   

### 2. SignIn :
   - **Unauthenticated**  : No API Key Is Specified 
   - **InvalidArgument**  : Unable to Validate Inputs   
   - **NotFound**         : User Not Exist 
   - **InvalidArgument**  : Unable to Validate Inputs   
   - **DeadlineExceeded** : Time Out    
   - **PermissionDenied** : Unable To Authenticate  
   - **Internal**         : Unable To Generate Refresh Token    
   
### 3. LogOut :
   - **Unauthenticated**  : No API Key Is Specified 
   - **Unauthenticated**  : Request With Invalid Token  

### 4. ContactConformation :
   - **Unauthenticated** : No API Key Is Specified  
   - **Unauthenticated** : Request With Invalid Token   
   - **Unknown**         : OTP Token Not Found  
   - **NotFound**        : Please Try Again (So Late For Conforming Contact)    
   - **Aborted**         : Unauthenticated User (OTP Match but Phone Number Not)    
   - **Unknown**         : Unable To Create User    
   - **Internal**        : Unable To Generate Refresh Token (Try To SignIn) 
   - **InvalidArgument** : Invalid OTP

### 5. ResendOTP :
   - **Unauthenticated**  : No API Key Is Specified 
   - **Unauthenticated**  : Request With Invalid Token  
   - **Unknown**          : OTP Token Not Found 
   - **Internal**         : Unable To Send OTP  
   - **Unknown**          : Unable To Process Request   

### 6. ForgetPassword :
  - **AlreadyExists**    : OTP Is Already Sent To User  
  - **Unauthenticated**  : No API Key Is Specified  
  - **InvalidArgument**  : Unable To Validate Inputs    
  - **PermissionDenied** : Not exist    
  - **Internal**         : Unable To Generate Refresh Token 
  - **Internal**         : Unable To Send OTP   
   
### 7. ConformForgetPasswordOTP :
  - **Unauthenticated**  : No API Key Is Specified  
  - **Unauthenticated**  : Request With Invalid Token   
  - **Unauthenticated**  : Request With Invalid Token   
  - **Unauthenticated**  : Request With Invalid Token   
  - **Internal**         : OTP Token Not Found  
  - **Internal**         : Unable To Generate Token 
  - **PermissionDenied** : Invalid OTP To Get Password  

### 8. SetNewPassword :
  - **Unauthenticated**  : No API Key Is Specified  
  - **Unauthenticated**  : Request With Invalid Token   
  - **InvalidArgument**  : Try With Stronger Password   
  - **Internal**         : Fail To Update Password  

### 9. GetNewToken :
  - **Unauthenticated**  : No API Key Is Specified
  - **Unauthenticated**  : Request With Invalid Token
  - **Internal**         : Unable To Generate Token
  - **InvalidArgument**  : Invalid Token

## Data Flow's

### 1. SignUp :
   
   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access". 
   2. Sanitize the inputs provided in the input form the user; If input provided by the user are not valid then send error "Invalid Input" else go to step-3. 
   3. Check is user already exist ? or not  in the cash by users phone number; If user already exist then send error "Already Exist" else go to step-4. 

  **Now as a security mechanism to avoid ddos attack form an unknown person by passing same unregistered contact number again and again and try to get OTP.** 
  **But if good user try to register and unfortunately at the time of OTP conformation his device failed then the user can register after a half hour.** 
  **Or frontend can redirect the user with that in progress contact number directly to the otp conformation page.** 

   4. Now Check is user with provided contact number is in progress or not ?. If it is then send error "In progress" else go to step-5. 
   5. Generate Random UUID For new user. 
   6. Generate the hash of password.
   7. Create the user temporarily in cash (Note : User Exist or not is validated by cash data). 
   8. Generate Refresh and Auth Tokens. 
   9. Send OTP to the contact number. 
   10. Send The Generated Refresh token and auth token to the user. 

   **the token from signUp rpc can only access to the following services : GetNewToken, ResendOTP, ConformContact** 


### 2. SignIn :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Sanitize the inputs provided in the input form the user; If input provided by the user are not valid then send error "Invalid Input" else go to step-3.
   3. Check is provided contact number is exist or not (Checking in cash) if pass then go to step-4 else send error "Not Exist".
   4. Get the user password's hash by phoneNo and then Hash the provided password and compare it with hash of password store in database
   5. If comparison is passed then user exist go to step-6 else send error "Not exist".
   6. Generate Refresh token and auth token and send them to client.

   **the token from signUp rpc can only access to the following services : LogOut, GetNewToken, External**

### 3. LogOut :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Auth Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Delete Refresh and Auth token.
   4. On Successful deletion of token send status to true else false.

### 4. ContactConformation : 

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Auth Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Get sent OTP from server cash.
   4. Check if OTP is equal to users typed OTP ? if equal then go to step-5 else send error "Invalid OTP".
   5. Get temporary user form cash.
   6. Delete Refresh token, OTP data, Temporary phoneNo from cash.
   7. Create Actual user in DataBase.
   8. Delete Temporary User data from cash.
   9. Generate Refresh and Auth token and send them to user.

   **the token from signUp rpc can only access to the following services : LogOut, GetNewToken, External**

### 5. Resend OTP :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Auth Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Get the OTP details from cash and check for resend times of otp and according to that send the otp or send error "Limit Exceeded"

### 6. ForgetPassword :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Sanitize the inputs provided in the input form the user; If input provided by the user are not valid then send error "Invalid Input" else go to step-3.
   3. Check For existence of contact number ( Checking Inside Cash ) If exist then go to step-4 else send error "Not Exist" . 
   4. Generate Refresh and Auth token for Forget Password.
   5. Generate and send OTP.
   6. Send Refresh and Auth token for Forget Password.

### 7. ConformForgetPasswordOTP :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Auth Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Get OTP From Cash.
   4. Compare OTP with received input; If equal then go to step 5 else send error "Invalid OTP".
   5. Delete OTP Data and Refresh token from cash.
   6. Generate Password Token and send.

### 8. SetNewPassword :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Auth Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Validate Password and if valid then go to step-4 else send error "Try With Stronger Password".
   4. Update Password and status to as a true.

### 9. GetNewToken :

   1. Check For API Key; If API key is valid then go to step-2 else send Error "UnAuthorized Access".
   2. Validate Refresh Token; If token is valid then go to step-3 else send error "UnAuthorized".
   3. Generate Auth Token and sent to user.

## Token Format
    
All the tokens are signed and encrypted with their own unique key to ensure security.

### 1. Refresh Token

    Audience    : string,
    Jti         : string,
    Subject     : string,
    Issuer      : string,
    IssuedAt    : time,
    Expiration  : time,
    NotBefore   : time,
    Authorized  : true/false
    AccessGroup : [int, ...]
    Footer      : string

- **Audience**   : Audience identifies the intended recipients of the token.
- **Jti**        : Jti is the refresh token id.
- **Subject**    : Subject is the username.
- **Issuer**     : Issuer is token issuer id (Domain)
- **IssuedAt**   : IssuedAt is the time at which the token was issued.
- **Expiration** : Expiration is a time on or after which the token must not be accepted for processing.
- **NotBefore**  : NotBefore is a time on or before which the token must not be accepted for processing.
- **Authorized** : Authorized identifies either token is for authorized user or unauthorized user.
- **AccessGroup**: AccessGroup identifies the limits of the token.
- **Footer**     : Footer is publicly readable to identify token; It represents brand name.


### 2. Auth Token

    Audience    : string,
    Jti         : string,
    Subject     : string,
    Issuer      : string,
    IssuedAt    : time,
    Expiration  : time,
    NotBefore   : time,
    Authorized  : true/false
    AccessGroup : [int, ...]
    Footer      : string

- **Audience**   : Audience identifies the intended recipients of the token.
- **Jti**        : Jti is the refresh token id.
- **Subject**    : Subject is the username.
- **Issuer**     : Issuer is token issuer id (Domain)
- **IssuedAt**   : IssuedAt is the time at which the token was issued.
- **Expiration** : Expiration is a time on or after which the token must not be accepted for processing.
- **NotBefore**  : NotBefore is a time on or before which the token must not be accepted for processing.
- **Authorized** : Authorized identifies either token is for authorized user or unauthorized user.
- **AccessGroup**: AccessGroup identifies the limits of the token.
- **Footer**     : Footer is publicly readable to identify token; It represents brand name.

### 3. Password Token

    Audience    : string,
    Subject     : string,
    Issuer      : string,
    IssuedAt    : time,
    Expiration  : time,
    NotBefore   : time,
    AccessGroup : [int, ...]
    Footer      : string

- **Audience**   : Audience identifies the intended recipients of the token.
- **Subject**    : Subject is the token id.
- **Issuer**     : Issuer is token issuer id (Domain)
- **IssuedAt**   : IssuedAt is the time at which the token was issued.
- **Expiration** : Expiration is a time on or after which the token must not be accepted for processing.
- **NotBefore**  : NotBefore is a time on or before which the token must not be accepted for processing.
- **AccessGroup**: AccessGroup identifies the limits of the token.
- **Footer**     : Footer is publicly readable to identify token; It represents brand name.

## DataBase Schema

    create table user_data(
        shop_id     varchar       primary key,
        username    varchar(254)  not null,
        password    varchar(254)  not null,
        phone_no    varchar(10)   not null unique,
        email       varchar(254)  unique,
        joined_time timestamp     not null
    );


## Storage Methods

- The refresh token are stored in cash; Key = refresh the token id and Value = refresh token and allocated time. 
- The auth token is not stored.
- The list of all existing contact is stored in HashMap in cash with map name contact and Key = PhoneNo (In Encoded Format) and Value = Email.
- The temporary contact number is stored in cash with Key = PhoneNo + "_TEMP_CONTACT" (In Encoded Format) and Value = Email.
- The generated OTP is stored in cash with Key = shopId and Value = OTP Data.

**Not All The Information Is Stored Only For Certain Amount Of Time In Cash Except List Of All Contacts.**

**This Is First Version Of Authentication System Lots Of Optimization Are Yet To Come If You Have AnyOne In Mind Fell Free To Create New Pull Request**

